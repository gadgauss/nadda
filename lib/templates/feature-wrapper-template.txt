var fs = require('fs'),
	path = require('path'),
	Yadda = require('yadda'),
	NY_PATH = '{ny_path}',
	tagRules = {tag_rules},
	yaddaInstance = require(path.resolve(NY_PATH, 'sandbox/steps-lib')),
	shouldRunScenario = require(path.resolve(NY_PATH, 'utils/should-run-scenario')),
	featureParser = new Yadda.parsers.FeatureParser(),
    feature = featureParser.parse(fs.readFileSync('{feature_location}', 'UTF-8'));

function getScenarioTags (scenario) {
	var tags = Object.keys(scenario.annotations) || [];
	return tags.map(function (tag) {
				return '@' + tag;
			});
}

function createScenarioFunc(scenario) {
	return function (browser) {
		if (!shouldRunScenario(tagRules, getScenarioTags(scenario))) {
			console.log('Not running scenario due to tag rules supplied');
			browser.end();
			return;
		}
		scenario.steps.push('close_browser');
		yaddaInstance.yadda(scenario.steps, {browser: browser});
	};
}

for (var j = 0, sl = feature.scenarios.length; j < sl; j++) {
	scenario = feature.scenarios[j];
	module.exports[scenario.title] = createScenarioFunc(scenario);
}
